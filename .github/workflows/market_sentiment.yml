name: 市场情绪监控

on:
  schedule:
    # UTC时间，需要转换为北京时间（UTC+8）
    # 北京时间 9:25 = UTC 01:25
    # 北京时间 10:30 = UTC 02:30
    # 北京时间 11:30 = UTC 03:30
    # 北京时间 14:00 = UTC 06:00
    # 北京时间 15:00 = UTC 07:00
    - cron: '25 1 * * 1-5'   # 开盘：周一至周五 9:25
    - cron: '30 2 * * 1-5'   # 盘中：周一至周五 10:30
    - cron: '30 3 * * 1-5'   # 午盘：周一至周五 11:30
    - cron: '0 6 * * 1-5'    # 盘中：周一至周五 14:00
    - cron: '0 7 * * 1-5'    # 收盘：周一至周五 15:00
  
  workflow_dispatch:  # 允许手动触发

jobs:
  monitor-sentiment:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install akshare pandas
      
      - name: 运行市场情绪监控
        run: |
          python -c "
          from market_sentiment import MarketSentimentMonitor
          import sys
          
          try:
              monitor = MarketSentimentMonitor()
              monitor.print_report()
          except Exception as e:
              print(f'执行失败: {e}')
              sys.exit(1)
          "
        continue-on-error: true
      
      - name: 保存报告（可选）
        if: success()
        run: |
          echo "市场情绪监控完成于: $(date)" >> sentiment_log.txt
        continue-on-error: true
      
      # 可选：发送通知到微信
      # - name: 发送通知
      #   if: success()
      #   env:
      #     SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}
      #   run: |
      #     python send_notification.py
